<!doctype html><html><head><meta charset="utf-8"><title>Return Book</title><link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'></script></head><body><script>
if(!localStorage.getItem('role') && !location.pathname.endsWith('login.html')) { location.href = '/login.html'; }
function logout(){ localStorage.removeItem('role'); location.href='/login.html'; }
function roleHeader(){ return {'x-role': localStorage.getItem('role')||''}; }
</script>
<div class="container mt-4"><h4>Return Book</h4><div class="mb-3"><label>Transaction ID</label><input id="tid" class="form-control"><button id="fetch" class="btn btn-sm btn-info mt-2">Fetch</button></div><div id="formArea"></div></div>
<script>document.getElementById('fetch').addEventListener('click', async function(){ const tid = document.getElementById('tid').value.trim(); if(!tid){ alert('Enter transaction id'); return; } const list = await (await fetch('/data/transactions.json')).json(); const tr = list.find(x=>x.id==tid); if(!tr){ alert('Not found'); return; } const book = await (await fetch('/api/books/'+tr.book_id, { headers: roleHeader() })).json(); const area = document.getElementById('formArea'); area.innerHTML = "<div class='card p-3'><p><strong>Book:</strong> "+book.title+"</p><p><strong>Author:</strong> "+book.author+"</p><p><strong>Issue Date:</strong> "+tr.issue_date+"</p><div class='mb-2'><label>Serial No</label><input id='serial' class='form-control' required></div><div class='mb-2'><label>Return Date</label><input id='rdate' type='date' class='form-control' value='"+new Date().toISOString().slice(0,10)+"'></div><div id='err' class='text-danger'></div><button id='confirm' class='btn btn-primary mt-2'>Confirm Return</button></div>"; document.getElementById('confirm').onclick = async function(){ const serial = document.getElementById('serial').value.trim(); const rdate = document.getElementById('rdate').value; if(!serial){ document.getElementById('err').innerText='Serial no required'; return; } const res = await fetch('/api/return', { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, roleHeader()), body: JSON.stringify({ transaction_id: parseInt(tid), serial_no: serial, return_date: rdate }) }); const data = await res.json(); if(!res.ok){ document.getElementById('err').innerText=data.message||'Error'; return; } localStorage.setItem('lastTransaction', JSON.stringify(data.transaction)); window.location.href='pay_fine.html'; }; });</script>
</body></html>