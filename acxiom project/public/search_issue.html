<!doctype html><html><head><meta charset="utf-8"><title>Search & Issue</title><link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'></script></head><body><script>
if(!localStorage.getItem('role') && !location.pathname.endsWith('login.html')) { location.href = '/login.html'; }
function logout(){ localStorage.removeItem('role'); location.href='/login.html'; }
function roleHeader(){ return {'x-role': localStorage.getItem('role')||''}; }
</script>
<div class="container mt-4"><h4>Search Books</h4><form id="searchForm"><div class="row"><div class="col"><input id="title" class="form-control" placeholder="Title"></div><div class="col"><input id="author" class="form-control" placeholder="Author"></div><div class="col"><input id="category" class="form-control" placeholder="Category"></div></div><div id="msg" class="text-danger mt-2"></div><button class="btn btn-primary mt-2">Search</button></form><div id="results" class="mt-3"></div></div>
<script>document.getElementById('searchForm').addEventListener('submit', async function(e){ e.preventDefault(); const title = document.getElementById('title').value.trim(); const author = document.getElementById('author').value.trim(); const category = document.getElementById('category').value.trim(); if(!title && !author && !category){ document.getElementById('msg').innerText='Enter at least one field'; return; } const res = await fetch('/api/books/search', { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, roleHeader()), body: JSON.stringify({ title, author, category }) }); const data = await res.json(); if(!res.ok){ document.getElementById('msg').innerText=data.message||'Error'; return; } const container = document.getElementById('results'); container.innerHTML=''; if(data.length===0){ container.innerHTML='<p>No results</p>'; return; } const form = document.createElement('form'); form.id='issueForm'; data.forEach(function(d){ const div = document.createElement('div'); div.className='form-check'; div.innerHTML = "<input class='form-check-input' type='radio' name='selected' value='"+d.id+"' id='b"+d.id+"'><label class='form-check-label' for='b"+d.id+"'>"+d.title+" - "+d.author+" ("+d.serial_no+")</label>"; form.appendChild(div); }); form.innerHTML += "<div class='mt-3'><label>Member Name</label><input id='mname' class='form-control' required></div><div class='mt-2'><label>Issue Date</label><input id='issueDate' type='date' class='form-control' value='"+new Date().toISOString().slice(0,10)+"'></div><div class='mt-2'><label>Return Date</label><input id='returnDate' type='date' class='form-control' value='"+new Date(new Date().getTime()+15*24*60*60*1000).toISOString().slice(0,10)+"'></div><div class='mt-2'><label>Remarks</label><input id='remarks' class='form-control'></div><div id='err' class='text-danger mt-2'></div><button class='btn btn-success mt-2'>Issue</button>"; container.appendChild(form); form.addEventListener('submit', async function(ev){ ev.preventDefault(); const sel = form.selected.value; const mname = document.getElementById('mname').value.trim(); const issueDate = document.getElementById('issueDate').value; const returnDate = document.getElementById('returnDate').value; if(!sel||!mname){ document.getElementById('err').innerText='Select book and enter member name'; return; } const today = new Date().toISOString().slice(0,10); if(issueDate < today){ document.getElementById('err').innerText='Issue date cannot be earlier than today'; return; } const res2 = await fetch('/api/issue', { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, roleHeader()), body: JSON.stringify({ book_id: parseInt(sel), member_name: mname, issue_date: issueDate, return_date: returnDate, remarks: document.getElementById('remarks').value }) }); const d2 = await res2.json(); if(!res2.ok){ document.getElementById('err').innerText=d2.message||'Error'; return; } alert('Issued. Transaction ID: '+d2.transaction.id); location.href='dashboard.html'; }); });</script>
</body></html>